<!DOCTYPE html>  <html> <head>   <title>transformer.rb</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               transformer.rb             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h3>Introduction</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>An <em>aAUTOMATOR</em> Robot specifies steps for doing web scraping of a
page or a set of pages. Each robot is built from several
transformers connected in the shape of a graph. Each transformer
type specifies some elemental operation to make. They are
parametrized and combined to create a whole robot. This robot is
specified in a XML format.</p>

<p>Here we define a DSL that we call <em>minilanguage</em>. It eases the
creation of <em>aAUTOMATOR</em> robots, so no longer is needed to create
verbose XML files. Instead we can use a <em>minilanguage</em> string to
define it.</p>

<p>We can create a new <em>aAUTOMATOR</em> robot by feeding a minilanguage
string to <em>Language</em>. <em>Language</em> class interprets it and creates a
tree of <em>Transformer</em> objects. This <em>Transformer</em>'s tree resembles
<em>aAUTOMATOR</em> XML format so the latter is easy to generate.</p>

<p><em>Language</em> interprets the <em>minilanguage</em> string by using the <code>eval</code>
capabilities of Ruby. At <em>Language</em> class there are methods for
creating transformers of each indidividual type. In order to not
have to define manually a method for each type of Transformer, we
generate them dinamically.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>We include java packages for generating the XML.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;java&#39;</span>
<span class="k">module</span> <span class="nn">XML</span>
  <span class="n">include_package</span> <span class="s1">&#39;javax.xml.parsers&#39;</span>
  <span class="n">include_package</span> <span class="s1">&#39;org.w3c.dom&#39;</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3><em>Transformer</em> as template for new sublcasses</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>We define methods to ease the definition of new <em>Transformer</em>
subclasses. These methods are called when the class is being
constructed and parametrize the behavior of the generated
subclass. Each generated <em>Transformer</em> subclass receives the values
for the parameters it requires when its constructor is
called. <em>Transformer</em> class will be reopened.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Transformer</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The <code>@variables</code> used inside of class methods(<code>self.method_name</code>)
are local to each subclass. They are instance variables of each
class metaclass.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This method is intended to be used inside the body of subclasses
from Transformer. It stores the value of the class as a symbol.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">transformer_class</span> <span class="n">value</span>
    <span class="vi">@transformer_class</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">to_sym</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">transformer_class_symbol</span>
    <span class="vi">@transformer_class</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Register a custom name for this Transformer subclass. By default,
the generated method name is built from the class name. But
sometimes that isn't suitable and a custom name must be provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">custom_name</span> <span class="nb">name</span>
    <span class="vi">@custom_name</span> <span class="o">=</span> <span class="nb">name</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_custom_name</span>
    <span class="vi">@custom_name</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>It stores a new param definition. This method is intended to be used
inside the body of subclasses from Transformer.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">param</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="nb">hash</span><span class="p">)</span>
    <span class="n">params_definitions</span> <span class="o">&lt;&lt;</span> <span class="no">ParamDefinition</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="nb">hash</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">params_definitions</span>
    <span class="p">(</span><span class="vi">@params_definitions</span><span class="o">||=[]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>It stores a param definition. It has a name, if it's required and a
default value. Each <em>Transformer</em> subclass has some different
<em>ParamDefinition</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">ParamDefinition</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">default_value</span> <span class="n">paramDefinition</span>
    <span class="n">paramDefinition</span> <span class="o">&amp;&amp;</span> <span class="n">paramDefinition</span><span class="o">.</span><span class="n">default_value</span>
  <span class="k">end</span>

  <span class="kp">attr_accessor</span> <span class="ss">:name</span>
  <span class="kp">attr_accessor</span> <span class="ss">:required</span>
  <span class="kp">attr_accessor</span> <span class="ss">:default_value</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_sym</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:required</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="kp">true</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:default_value</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>We reopen <em>Transformer</em> class to add a hook: <code>self.inherited</code> is
called each time a new subclass of <em>Transformer</em> is defined.</p>

<p>This is a partial definition. <em>Transformer</em> class will be reopened.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Transformer</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Whenever a new subclass of <em>Transformer</em> is created, we tell
Language. We also keep track of the subclasses added.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">inherited</span> <span class="n">subclass</span>
    <span class="no">Language</span><span class="o">.</span><span class="n">new_type_of_transformer</span><span class="p">(</span><span class="n">subclass</span><span class="p">)</span>
    <span class="p">(</span><span class="vc">@@subclasses</span> <span class="o">||=</span> <span class="o">[]</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">subclass</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The name of the method to be added to <em>Language</em>. It's created from
the name of the class with the first letter in lowercase, unless
it's has been customized.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">language_method_name</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">get_custom_name</span> <span class="o">||</span> <span class="nb">self</span><span class="o">.</span><span class="n">lowercase_first</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">lowercase_first</span> <span class="n">word</span>
    <span class="n">word</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">].</span><span class="n">downcase</span> <span class="o">+</span> <span class="n">word</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">word</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>In <em>Language</em> class an instance method is created for each of the
subclasses of <em>Transformer</em>. This is a partial
definition. <em>Language</em> class will be reopened.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Language</span>

  <span class="vc">@@pending_method_definitions</span> <span class="o">=</span> <span class="o">[]</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Once a transformer class is created, a method that creates a
transformer instance of that type is <em>eventually</em> added to
Language. The newly generated method will call
<code>transformer_added_action</code> with the provided parameters.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>We can't define the new method immediately because when the
<code>inherited</code> hook is called the body of the Transformer subclass has
not been executed yet. <code>language_method_name</code> wouldn't still be
defined.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_type_of_transformer</span> <span class="n">transformer_klass</span>
    <span class="vc">@@pending_method_definitions</span> <span class="o">&lt;&lt;</span> <span class="nb">lambda</span> <span class="p">{</span>
      <span class="n">define_method_for</span> <span class="n">transformer_klass</span>
    <span class="p">}</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>For example after defining the class <code>PatternMatcher</code> a new method
<code>patternMatcher</code> is defined on <em>Language</em> class, once the
<code>register_pending_method_definitions</code> is called. The methods
generated receive some arguments that will be passed directly to the
class constructor. If a block is provided, it's evaluated in a new
<em>Language</em> instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">define_method_for</span> <span class="n">transformer_klass</span>
    <span class="n">define_method</span><span class="p">(</span><span class="n">transformer_klass</span><span class="o">.</span><span class="n">language_method_name</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
      <span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer_klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">transformer_added_action</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">block</span>
        <span class="no">Language</span><span class="o">.</span><span class="n">new</span> <span class="n">transformer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
      <span class="k">end</span>
      <span class="nb">self</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>It invokes all the pending method defintions causing the methods for
each transformer to  be defined.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">register_pending_method_definitions</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This race condition doesn't matter because all transformers are
defined before languages are started to be instantiated.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">pending</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span> <span class="vc">@@pending_method_definitions</span>
    <span class="vc">@@pending_method_definitions</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">pending</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span>
      <span class="n">l</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Now let's define some <em>Transformer</em> subclasses that will cause
methods to be added to the minilanguage. Notice how we use
<code>transformer_class</code> and <code>param</code> methods defined before to simplify
the definition of <em>Transformer</em> classes.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>It defines the <code>patternMatcher</code> call on <em>Language</em>. It can be used as
<code>patternMatcher('regexHere')</code> or
<code>patternMatcher(:pattern=&gt;'regexHere')</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">PatternMatcher</span> <span class="o">&lt;</span> <span class="no">Transformer</span>
  <span class="n">transformer_class</span> <span class="ss">:PatternMatcher</span>
  <span class="n">param</span> <span class="ss">:pattern</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">param</span> <span class="ss">:dotAll</span><span class="p">,</span> <span class="ss">:default_value</span> <span class="o">=&gt;</span> <span class="kp">false</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>It defines the <code>xpath</code> call on <em>Language</em>. It can be used as
<code>xpath('//a/@href')</code> or <code>xpath(:Xpath-&gt;'//a/@href')</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Xpath</span> <span class="o">&lt;</span> <span class="no">Transformer</span>
  <span class="n">transformer_class</span> <span class="ss">:HTMLMatcher</span>
  <span class="n">param</span> <span class="ss">:XPath</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>This is not intended to be used as a direct call on <em>Language</em>. It
acts as a container of other transformers. For that you should use
the special calls <code>pipe</code> and <code>branch</code> that accept blocks.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">SimpleTransformer</span> <span class="o">&lt;</span> <span class="no">Transformer</span>
  <span class="n">transformer_class</span> <span class="ss">:SimpleTransformer</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>It defines the <code>appender</code> call on <em>Language</em>. It can be used as
<code>appender('&lt;br /&gt;')</code> or <code>xpath(:append-&gt;'&lt;br /&gt;')</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Appender</span> <span class="o">&lt;</span> <span class="no">Transformer</span>
  <span class="n">transformer_class</span> <span class="ss">:Appender</span>
  <span class="n">param</span> <span class="ss">:append</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>It defines the <code>url</code> call on <em>Language</em>. <code>@@custom_names</code> on
transformer class is used to customize the name. It's used as <code>url</code>
or <code>url(:description=&gt;'whatever')</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">URLRetriever</span> <span class="o">&lt;</span> <span class="no">Transformer</span>
  <span class="n">custom_name</span> <span class="s2">&quot;url&quot;</span>
  <span class="n">transformer_class</span> <span class="ss">:URLRetriever</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>It defines the <code>replacer</code> call on <em>Language</em>. It's used as
<code>replacer(:sourceRE=&gt; '', :dest=&gt;'')</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Replacer</span> <span class="o">&lt;</span> <span class="no">Transformer</span>
  <span class="n">transformer_class</span> <span class="ss">:Replacer</span>
  <span class="n">param</span> <span class="ss">:sourceRE</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">param</span> <span class="ss">:dest</span><span class="p">,</span> <span class="ss">:required</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>It defines the <code>decorator</code> call on <em>Language</em>. It's used as
<code>decorator(:head=&gt; '&lt;p&gt;', :dest=&gt;'&lt;/p&gt;')</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Decorator</span> <span class="o">&lt;</span> <span class="no">Transformer</span>
  <span class="n">transformer_class</span> <span class="ss">:Decorator</span>
  <span class="n">param</span> <span class="ss">:head</span><span class="p">,</span> <span class="ss">:default_value</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span>
  <span class="n">param</span> <span class="ss">:tail</span><span class="p">,</span> <span class="ss">:default_value</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>It defines the <code>merger</code> call on <em>Language</em>. It's used as
<code>merger</code>. It has no required parameters.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Merger</span> <span class="o">&lt;</span> <span class="no">Transformer</span>
  <span class="n">transformer_class</span> <span class="ss">:Merger</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h3><em>Transformer</em> instantiation.</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>We reopen the <em>Transformer</em> class to show how it's instantiated. The
initialize constructor is called when calling the method dinamically
generated on <em>Language</em> class.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Transformer</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>As you can see <code>arguments</code> is a variable list of arguments. It can
have zero, one, two or three arguments. If branch parameters are
provided they are the first two. The params are the last one, but
it's optional.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">split_parameters</span> <span class="n">arguments</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">arguments</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">arguments</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">arguments</span><span class="o">.</span><span class="n">last</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>branch parameters provided</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">2</span>
      <span class="o">[</span><span class="n">arguments</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">]</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>no branch parameters</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="o">[[]</span><span class="p">,</span> <span class="n">params</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>A transformer constructor. It's called from <em>Language</em> when the
concrete method associated to this class is called. Examples of
calls on <em>Language</em> that can trigger this:</p>

<pre><code>patternMatcher('(http://.*)')
decorator(:head=&gt;"&lt;h1&gt;", :tail=&gt;"&lt;/h1&gt;", :description=&gt;"wrapping")
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">initialize</span> <span class="o">*</span><span class="n">arguments</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Check that <code>transformer_class</code> has been defined</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">unless</span> <span class="n">klass</span><span class="o">.</span><span class="n">transformer_class_symbol</span>
      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;transformer_class must be defined in </span><span class="si">#{</span><span class="n">klass</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="n">branch_parameters</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">split_parameters</span> <span class="n">arguments</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>We ensure the params is in a Hash form, that the branch parameters
are added, and that if a key is not found the value in
default_values is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">params</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">ensure_params_is_hash</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">with_branch_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">branch_parameters</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">with_defaults</span> <span class="n">params</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>We set instance attributes from the params. Notice that if the value
is not present, the default values are used.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@description</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:description</span><span class="o">]</span>
    <span class="vi">@branchtype</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:branchtype</span><span class="o">].</span><span class="n">to_sym</span>
    <span class="vi">@branchmergemode</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:branchmergemode</span><span class="o">].</span><span class="n">to_sym</span>
    <span class="vi">@loop</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:loop</span><span class="o">]</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>We extract the values from the params for the param definitions and
we generate the accessors.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@params</span> <span class="o">=</span> <span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">values_for_param_definitions</span> <span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">freeze</span>
    <span class="n">klass</span><span class="o">.</span><span class="n">generate_named_accessors_for_parameters</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>The default values used for the standard parameters. If the value
are equal to these they don't have to be provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vc">@@default_values</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:branchtype</span> <span class="o">=&gt;</span> <span class="ss">:CASCADE</span><span class="p">,</span> <span class="ss">:branchmergemode</span> <span class="o">=&gt;</span> <span class="ss">:SCATTERED</span><span class="p">,</span>
    <span class="ss">:loop</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Create a new hash with the contents of <code>hash</code> and that fallbacks to
<code>@@defaults_values</code> and the param definition if some key is not
found.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">with_defaults</span> <span class="nb">hash</span>
    <span class="n">result</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="nb">hash</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="ss">:description</span>
        <span class="n">transformer_class_symbol</span><span class="o">.</span><span class="n">to_s</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="vc">@@default_values</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
          <span class="vc">@@default_values</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
        <span class="k">else</span>
          <span class="no">ParamDefinition</span><span class="o">.</span><span class="n">default_value</span><span class="p">(</span><span class="n">find_param_definition</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="p">}</span>
    <span class="n">result</span><span class="o">.</span><span class="n">merge!</span> <span class="nb">hash</span>
    <span class="n">result</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_param_definition</span> <span class="nb">name</span>
    <span class="n">params_definitions</span><span class="o">.</span><span class="n">find</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">to_sym</span> <span class="o">==</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_sym</span><span class="p">}</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Add to the params hash the branch params if they exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">with_branch_params</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">branch_params</span><span class="p">)</span>
    <span class="nb">hash</span><span class="o">[</span><span class="ss">:branchtype</span><span class="o">]</span> <span class="o">=</span> <span class="n">branch_params</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="k">if</span> <span class="n">branch_params</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="nb">hash</span><span class="o">[</span><span class="ss">:branchmergemode</span><span class="o">]</span> <span class="o">=</span> <span class="n">branch_params</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="k">if</span> <span class="n">branch_params</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="nb">hash</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>If params is a Hash we return early.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">ensure_params_is_hash</span> <span class="n">provided_params_values</span>
    <span class="k">return</span> <span class="n">provided_params_values</span> <span class="k">if</span> <span class="no">Hash</span> <span class="o">===</span> <span class="n">provided_params_values</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Otherwise we create a new Hash and if there is only one required
param we set the value of that param for the single value provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">single_argument</span> <span class="o">=</span> <span class="n">provided_params_values</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">params_definitions</span><span class="o">.</span><span class="n">find_all</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">required</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">required</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="n">result</span><span class="o">[</span><span class="n">required</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">single_argument</span>
    <span class="k">end</span>
    <span class="n">result</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Extracts from the provided params hash, the actual values taking
into account the default values. It also checks that all the
required parameters without default values are set.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">values_for_param_definitions</span> <span class="n">provided_params_values</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">provided_params_values</span><span class="o">.</span><span class="n">clone</span>
    <span class="n">params_definitions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">result</span><span class="o">[</span><span class="nb">p</span><span class="o">.</span><span class="n">name</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">p</span><span class="o">.</span><span class="n">required</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">p</span><span class="o">.</span><span class="n">default_value</span>
        <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> parameter is required&quot;</span>
      <span class="k">end</span>
      <span class="n">result</span><span class="o">[</span><span class="nb">p</span><span class="o">.</span><span class="n">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="nb">p</span><span class="o">.</span><span class="n">name</span><span class="o">]</span> <span class="o">||</span> <span class="nb">p</span><span class="o">.</span><span class="n">default_value</span>
    <span class="k">end</span>
    <span class="n">result</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>It generates dinamically accessors for the parameters definitions in
this instance, the values are the ones stored in
<code>instance_variable_name</code>. For example for <code>PatternMatcher</code> we
generate <code>pattern</code> and <code>dotAll</code> accessors.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">generate_named_accessors_for_parameters</span> <span class="n">instance_variable_name</span>
    <span class="n">params_definitions</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">param_definition</span><span class="o">|</span>
      <span class="nb">module_eval</span> <span class="o">&lt;&lt;-</span><span class="no">END</span>
<span class="sh">        def #{param_definition.name}</span>
<span class="sh">          @#{instance_variable_name}[:#{param_definition.name}]</span>
<span class="sh">        end</span>
<span class="no">      END</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Some accessors for properties common for all transformers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kp">attr_reader</span> <span class="ss">:branchtype</span>
  <span class="kp">attr_reader</span> <span class="ss">:branchmergemode</span>
  <span class="kp">attr_reader</span> <span class="ss">:description</span>

  <span class="k">def</span> <span class="nf">transformer_class</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">transformer_class_symbol</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">children</span>
    <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@children</span> <span class="o">||</span> <span class="o">[]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">loop?</span>
    <span class="vi">@loop</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">params</span>
    <span class="vi">@params</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <h3><em>Language</em> interpretation</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>We reopen <em>Transformer</em> to add the methods needed by <em>Language</em> to
manipulate each created transformer.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Transformer</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p><em>aAUTOMATOR</em> expects that the loop control is the first element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">do_loop_with</span> <span class="n">loop_control_transformer</span>
    <span class="p">(</span><span class="vi">@children</span> <span class="o">||=</span> <span class="o">[]</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">loop_control_transformer</span><span class="p">)</span>
    <span class="vi">@loop</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Append a child to this transformer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">add_child</span> <span class="n">child</span>
    <span class="p">(</span><span class="vi">@children</span> <span class="o">||=</span> <span class="o">[]</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">child</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Besides the methods presented here this class contains all the
methods generated by the <em>Transformer</em> subclasses definitions. The
Language uses Ruby blocks to create nested scopes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Language</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>This is the entering point for <em>Language</em>. A new <em>Language</em> instance
is created, against which the <code>language_str</code> is evaluated. For
example if <code>language_str</code> is <code>url | xpath('//a/@href')</code> the methods
<code>url</code>, <code>|</code> and <code>xpath</code>, <code>|</code> are executed on the new <em>Language</em>
instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">language_eval</span> <span class="n">language_str</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="kp">nil</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">create_top_level</span>
    <span class="n">args</span> <span class="o">=</span> <span class="o">[</span><span class="n">language_str</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="o">].</span><span class="n">reject</span><span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="o">.</span><span class="n">nil?</span><span class="p">}</span>
    <span class="n">language</span><span class="o">.</span><span class="n">instance_eval</span> <span class="o">*</span><span class="n">args</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>We return the top level generated transformer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">language</span><span class="o">.</span><span class="n">transformer</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>The root transformer is a <em>SimpleTransformer</em> that works in cascade
mode.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_top_level</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="no">Language</span><span class="o">.</span><span class="n">new</span> <span class="no">SimpleTransformer</span><span class="o">.</span><span class="n">new</span><span class="p">({}),</span> <span class="o">&amp;</span><span class="n">block</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Method used in the tests. It's mostly the same as language_eval but
instead of a string to be evaled it receives a Ruby block of
code.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">interpret</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">create_top_level</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="n">l</span><span class="o">.</span><span class="n">transformer</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Method called when a new transformer is created using one of the
dinamically defined methods. It adds the created transformer
instance to the current transformer. For example, calling
<code>patternMatcher('regexHere')</code> on some <em>Language</em> scope adds it as a
child to this Language's instance <code>@transformer</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">transformer_added_action</span> <span class="n">transformer</span>
    <span class="vi">@transformer</span><span class="o">.</span><span class="n">add_child</span> <span class="n">transformer</span>
  <span class="k">end</span>
  <span class="kp">protected</span> <span class="ss">:transformer_added_action</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>This is syntactic sugar. Inside the top level scope or a pipe scope
the <code>|</code> separator can be used to separate several transformer
instantiations. The Ruby statement separator <code>;</code> can be used too,
but <code>|</code> gives it a 'flowing' look.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">&gt;</span> <span class="n">other</span>
    <span class="nb">self</span> <span class="o">|</span> <span class="n">other</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">|</span> <span class="n">other</span>
    <span class="k">if</span> <span class="vi">@transformer</span><span class="o">.</span><span class="n">branchtype</span> <span class="o">!=</span> <span class="ss">:CASCADE</span>
      <span class="k">raise</span> <span class="s2">&quot;| can&#39;t be used in a pipe branch&quot;</span>
    <span class="k">end</span>
    <span class="nb">self</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Constructor for a <em>Language</em>. Both params and block are optional. It
creates a <code>SimpleTransformer</code> as container. It interprets the
optionally provided block in the context of the <em>Language</em> being
created. It also registers the pending method definitions to ensure
that they are available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">transformer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="no">Language</span><span class="o">.</span><span class="n">register_pending_method_definitions</span>
    <span class="vi">@transformer</span> <span class="o">=</span> <span class="n">transformer</span>
    <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="k">if</span> <span class="n">block</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>The transformer that is being modified in this <code>Language</code> instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">transformer</span>
    <span class="vi">@transformer</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>With what we have shown so far we only could create transformers
that don't have other nested transformers. Now we define some
methods that let us create nested scopes inside a Language. Each
scope is a <em>Language</em> instance so more nested scopes can be created
recursively. This scope methods receive Ruby blocks. Ruby blocks can
be delimited with braces which is a very readable nesting construct.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>It creates a new minilanguage scope with pipe semantics. For example
a pipe could be:</p>

<pre><code>url | pipe {xpath('//a/@href') |
            patternMatcher('(http://.*)')}
</code></pre>

<p>A transformer with two children would be created: url and a
SimpleTransformer with xpath and patternMatcher as children:</p>

<pre><code>SimpleTransformer :branchtype =&gt; :CASCADE
  - url
  - SimpleTransformer :branchtype =&gt; :CASCADE
    - xpath
    - patternMatcher
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">pipe</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="no">Language</span><span class="o">.</span><span class="n">new</span> <span class="no">SimpleTransformer</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="vi">@transformer</span><span class="o">.</span><span class="n">add_child</span> <span class="n">pipe</span><span class="o">.</span><span class="n">transformer</span>
    <span class="n">pipe</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>It creates a new minilanguage scope with branch semantics. A branch
requires that its type and merge mode are specified as params. The
provided block is interpreted with the newly created instance. The
children of a branch must be separed by newlines, never by <code>|</code>. An
example of branch is:</p>

<pre><code>branch(:BRANCH_DUPLICATED, :COLLAPSED) {
  decorator(:head=&gt;"&lt;h1&gt;", :tail =&gt; "&lt;/h1&gt;")
  url
}
</code></pre>

<p>It would generate:</p>

<pre><code>SimpleTransformer :branchtype =&gt; :BRANCH_DUPLICATED
                  :branchmergemode =&gt; :SCATTERED
  - decorator :head =&gt; "&lt;h1&gt;", :tail =&gt; "&lt;/h1&gt;"
  - url
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">branch</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
      <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;branchtype and branchmerge mode required&quot;</span>
    <span class="k">end</span>
    <span class="n">branch</span> <span class="o">=</span> <span class="no">Language</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">SimpleTransformer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="vi">@transformer</span><span class="o">.</span><span class="n">add_child</span> <span class="n">branch</span><span class="o">.</span><span class="n">transformer</span>
    <span class="n">branch</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>It tells that the current transformer is executed in a loop. The
provided block is used as the loop control. For example:</p>

<pre><code>url { patternMatcher(:pattern=&gt;"somePattern")}.repeat? {
            patternMatcher(:pattern=&gt;"somePattern") |
            decorator(:head=&gt;"someURL")}
</code></pre>

<p>Notice how a transformer can receive other as children. By default
they are in cascade mode (the same as <code>pipe</code>). This is specially
useful with <code>repeat?</code> blocks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">repeat?</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
    <span class="n">clause</span> <span class="o">=</span> <span class="no">RepeatClause</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">SimpleTransformer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clause</span><span class="o">.</span><span class="n">transformer</span>
      <span class="vi">@transformer</span><span class="o">.</span><span class="n">do_loop_with</span> <span class="n">clause</span><span class="o">.</span><span class="n">transformer</span>
    <span class="k">end</span>
    <span class="nb">self</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>It interprets the parts inside of a <code>repeat?</code> block.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">RepeatClause</span> <span class="o">&lt;</span> <span class="no">Language</span>

  <span class="n">alias_method</span> <span class="ss">:standard_added_action</span><span class="p">,</span> <span class="ss">:transformer_added_action</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Instead of adding the created transformer to the container the
children of the repeat clase are stored.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">transformer_added_action</span> <span class="n">transformer</span>
    <span class="p">(</span><span class="vi">@transformers</span><span class="o">||=[]</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">transformer</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>When we want to retrieve the transformer we look at the transformers
that have been added.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">transformer</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>We add them to the implicit container first.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">(</span><span class="vi">@transformers</span> <span class="o">||</span> <span class="o">[]</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">standard_added_action</span> <span class="n">t</span>
    <span class="k">end</span>
    <span class="vi">@transformers</span><span class="o">.</span><span class="n">clear</span> <span class="k">if</span> <span class="vi">@transformers</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>If only one transformer instantiated on the repeat clause we return
it. Otherwise we return the implicit container.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="k">super</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="k">super</span><span class="o">.</span><span class="n">children</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="k">else</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <h3><em>aAUTOMATOR</em> XML building</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>It exposes methods to ease the creation of the XML for an
<em>aAUTOMATOR</em> <em>robot</em>. New <em>XMLBuilder</em> instances are created for
each transformer node.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">XMLBuilder</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>It creates a new XML Document</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="no">XML</span><span class="o">::</span><span class="no">DocumentBuilderFactory</span><span class="o">.</span><span class="n">newInstance</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">setNamespaceAware</span> <span class="kp">false</span>
    <span class="no">XMLBuilder</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">newDocumentBuilder</span><span class="o">.</span><span class="n">newDocument</span><span class="p">)</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>A <em>XMLBuilder</em> must have a reference to the document and the node
it's acting on. At the start that's the root document.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">doc</span><span class="p">)</span>
    <span class="vi">@doc</span> <span class="o">=</span> <span class="n">doc</span>
    <span class="vi">@node</span> <span class="o">=</span> <span class="n">node</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>When adding a new element a new <em>XMLBuilder</em> is created so that
element can be subsequently modified.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">add_element</span> <span class="nb">name</span>
    <span class="n">element</span> <span class="o">=</span> <span class="vi">@doc</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="vi">@node</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="no">XMLBuilder</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@doc</span><span class="p">,</span><span class="n">element</span><span class="p">)</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Using <em>AttributesWrapper</em> to simplify attribute modification</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">attributes</span>
    <span class="vi">@attributes_wrapper</span> <span class="o">||=</span> <span class="no">AttributesWrapper</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@node</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">document</span>
    <span class="vi">@doc</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">node</span>
    <span class="vi">@node</span>
  <span class="k">end</span>
  <span class="kp">protected</span> <span class="ss">:node</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Add param element to transformer element with the provided value</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">add_param</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">param_element</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">add_element</span> <span class="s1">&#39;param&#39;</span>
    <span class="n">param_element</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;key&#39;</span><span class="o">]=</span> <span class="n">key</span><span class="o">.</span><span class="n">to_s</span>
    <span class="n">text</span> <span class="o">=</span> <span class="vi">@doc</span><span class="o">.</span><span class="n">createTextNode</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="n">param_element</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">param_element</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>It eases the way of setting attributes to an XML Element</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">AttributesWrapper</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="vi">@element</span> <span class="o">=</span> <span class="n">element</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">[]=</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
    <span class="vi">@element</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Method to be called from the Java side with the language
string. It's interpreted by <em>Language</em> and the transformer generated
along its children is converted to XML.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_xml</span> <span class="n">str</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="kp">nil</span>
  <span class="n">transformer</span> <span class="o">=</span> <span class="no">Language</span><span class="o">.</span><span class="n">language_eval</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
  <span class="n">transformer</span><span class="o">.</span><span class="n">convert_to_xml</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>We reopen the <em>Transformer</em> class to define the methods needed to
convert to xml.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Transformer</span>

  <span class="k">def</span> <span class="nf">convert_to_xml</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="no">XMLBuilder</span><span class="o">.</span><span class="n">create</span>
    <span class="n">robot</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add_element</span> <span class="s1">&#39;robot&#39;</span>
    <span class="n">robot</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;version&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">fill_transformer_element</span><span class="p">(</span><span class="n">robot</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="s1">&#39;transformer&#39;</span><span class="p">))</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">document</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>It fills the properties needed for an <em>aAUTOMATOR</em> transformer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">fill_transformer_element</span> <span class="n">builder</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>We set the attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">builder</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;class&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">transformer_class_symbol</span><span class="o">.</span><span class="n">to_s</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;branchtype&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">branchtype</span><span class="o">.</span><span class="n">to_s</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;branchmergemode&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">branchmergemode</span><span class="o">.</span><span class="n">to_s</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;loop&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="kp">loop</span><span class="p">?</span><span class="o">.</span><span class="n">to_s</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>We add the params as elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">params</span><span class="o">.</span><span class="n">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="n">builder</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>We apply this same method recursively to the children</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">children</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">child</span><span class="o">|</span>
      <span class="n">child</span><span class="o">.</span><span class="n">fill_transformer_element</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="s2">&quot;transformer&quot;</span><span class="p">))</span>
    <span class="k">end</span>
    <span class="n">builder</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <h3>From <em>aAUTOMATOR</em> XML to minilanguage</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>It takes an XML in <em>aAUTOMATOR</em> format and generates a minilanguage
string that would generate it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">to_minilanguage</span> <span class="n">xml</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>The document element is robot and its children are the top level transformers</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">children_to_minilanguage</span><span class="p">(</span><span class="n">xml</span><span class="o">.</span><span class="n">getDocumentElement</span><span class="p">,</span> <span class="s2">&quot; | &quot;</span><span class="p">)</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>It converts the transformer children of an element to minilanguage.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">children_to_minilanguage</span> <span class="n">parent</span><span class="p">,</span> <span class="n">separator</span>
  <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Lambda that converts an element to minilanguate taking into account
its position.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="n">generate_element</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">element</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>We retrieve the Transformer class associated to the element.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">transformer_class</span> <span class="o">=</span> <span class="no">Transformer</span><span class="o">.</span><span class="n">get_class_for</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">))</span>
    <span class="k">unless</span> <span class="n">transformer_class</span>
      <span class="k">raise</span> <span class="s2">&quot;not found class for </span><span class="si">#{</span><span class="n">element</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">separator</span> <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>The retrieved transformer_class knows how to convert itself to
minilanguage. We provide a block that knows how to generate the
children. It basically calls this method recursively.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">transformer_class</span><span class="o">.</span><span class="n">to_minilanguage</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">sep</span><span class="o">|</span>
      <span class="n">children_to_minilanguage</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">loop_control</span> <span class="o">=</span> <span class="n">get_loop_control</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">loop_control</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;.repeat?{</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">loop_control</span><span class="o">.</span><span class="n">each_with_index</span> <span class="o">&amp;</span><span class="n">generate_element</span>
      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;}&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">get_transformers</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">each_with_index</span> <span class="o">&amp;</span><span class="n">generate_element</span>
  <span class="n">result</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>If the transformer has the loop property the first transformer will
work as loop control. Otherwise all work as standard transformers.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">partition_transformers</span> <span class="n">parent</span>
  <span class="n">all</span> <span class="o">=</span> <span class="n">children_list</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">select_with_name</span><span class="p">(</span><span class="s2">&quot;transformer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
  <span class="n">is_loop</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;loop&#39;</span><span class="p">)</span> <span class="o">=~</span> <span class="sr">/true/</span>
  <span class="k">if</span> <span class="n">is_loop</span>
    <span class="o">[</span><span class="n">all</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">all</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">all</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]]</span>
  <span class="k">else</span>
     <span class="o">[[]</span><span class="p">,</span> <span class="n">all</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">get_transformers</span> <span class="n">parent</span>
  <span class="n">partition_transformers</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">get_loop_control</span> <span class="n">parent</span>
  <span class="n">partition_transformers</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>We reopen <em>Transformer</em> class to add the parts for converting XML to
minilanguage.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">Transformer</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>For a given transformer class name (the one without the package) and
present in the class attribute of the transformer element in
<em>aAUTOMATOR's</em> XML. It returns the appropriate subclass of
<em>Transformer</em></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_class_for</span> <span class="n">simple_java_class_name</span>
    <span class="n">subclasses_by_name</span><span class="o">[</span><span class="n">simple_java_class_name</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subclasses_by_name</span>
    <span class="vc">@@subclasses</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">acc</span><span class="p">,</span> <span class="n">subclass</span><span class="o">|</span>
      <span class="n">acc</span><span class="o">[</span><span class="n">subclass</span><span class="o">.</span><span class="n">transformer_class_symbol</span><span class="o">]</span> <span class="o">=</span> <span class="n">subclass</span>
      <span class="n">acc</span>
    <span class="p">}</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>It converts the provided transformer element to a subpart of the
resulting minilanguage. For generating the children we use
<code>children_content</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">to_minilanguage</span> <span class="n">element</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">children_content</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>We extract the params to use.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">params</span> <span class="o">=</span> <span class="n">with_defaults</span><span class="p">(</span><span class="n">extract_params_from_element</span><span class="p">(</span><span class="n">element</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>If no further transformer children we generate the call.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">loop_control</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">partition_transformers</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">children</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">as_call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>If both branch parameters are equal to the default values it's a pipe.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="n">is_pipe</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:branchtype</span><span class="p">,</span> <span class="ss">:branchmergemode</span><span class="o">].</span><span class="n">all?</span><span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="o">|</span>
        <span class="n">params</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">==</span> <span class="vc">@@default_values</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="n">is_pipe</span>
        <span class="n">generate_pipe</span> <span class="n">params</span><span class="p">,</span> <span class="n">children_content</span>
      <span class="k">else</span>
        <span class="n">branch_parameters</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:branchtype</span><span class="p">,</span> <span class="ss">:branchmergemode</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="o">|</span>
          <span class="n">params</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">to_sym</span>
        <span class="p">}</span>
        <span class="n">generate_branch</span> <span class="n">branch_parameters</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">children_content</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>It generates the string for a pipe. If the type is a
<em>SimpleTransformer</em> a <code>pipe</code> call is generated. Otherwise we use the
<em>Language</em> method name for the class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">generate_pipe</span> <span class="n">params</span><span class="p">,</span> <span class="n">children_content</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="nb">self</span> <span class="o">!=</span> <span class="no">SimpleTransformer</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">language_method_name</span> <span class="o">||</span> <span class="s2">&quot;pipe&quot;</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">params</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="nb">self</span> <span class="o">==</span> <span class="no">SimpleTransformer</span>
      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">as_named_arguments</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;)&quot;</span>
    <span class="k">end</span>
    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; {&quot;</span>
    <span class="n">result</span>  <span class="o">&lt;&lt;</span> <span class="n">children_content</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot; | &quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;}&quot;</span>
    <span class="n">result</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>It generates the string for a branch. If the type is a
<em>SimpleTransformer</em> a <code>branch</code> call is generated. Otherwise we use
the <em>Language</em> method name for the class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">generate_branch</span> <span class="n">branch_parameters</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">children_content</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="nb">self</span> <span class="o">!=</span> <span class="no">SimpleTransformer</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">language_method_name</span> <span class="o">||</span> <span class="s2">&quot;branch&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;(</span><span class="si">#{</span><span class="n">branch_parameters</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">inspect</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">branch_parameters</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">unless</span> <span class="n">params</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="nb">self</span> <span class="o">==</span> <span class="no">SimpleTransformer</span>
      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">as_named_arguments</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;) {</span><span class="se">\n</span><span class="s2">  &quot;</span>
    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">children_content</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span>
    <span class="n">result</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extract_params_from_element</span> <span class="n">element</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>We extract the params that come from the transformer element attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">params</span> <span class="o">=</span> <span class="n">params_from_xml_attributes</span> <span class="n">element</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Each child param element have a key attribute and its value as text content.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">children_list</span><span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="n">select_with_name</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">param_element</span><span class="o">|</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">param_element</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_sym</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">param_element</span><span class="o">.</span><span class="n">getTextContent</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">strip</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>If the parameter element value is different than the default we
assign it to the params.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">unless</span> <span class="n">omitting_would_produce_same_value?</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">params</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">params</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>The parameters that come from the attributes are the ones defined in
<code>@@default_values</code>: <code>:branchtype</code> and <code>:branchmergemode</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">params_from_xml_attributes</span> <span class="n">element</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="vc">@@default_values</span><span class="o">.</span><span class="n">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="o">|</span>
      <span class="n">attrValue</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Only if the attribute value is different than the default value we
assign it to the params. The loop attribute is ignored here too.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">unless</span> <span class="n">are_equal?</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="n">attrValue</span><span class="p">)</span>
        <span class="n">params</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">attrValue</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="ss">:loop</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">params</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>It produces the same value if it has the same value as the default
value for the key.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">omitting_would_produce_same_value?</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="n">with_defaults</span><span class="p">({})</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
    <span class="n">are_equal?</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">are_equal?</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dom_value</span><span class="p">)</span>
    <span class="n">dom_value</span> <span class="o">==</span> <span class="n">value</span> <span class="o">||</span> <span class="n">dom_value</span> <span class="o">==</span> <span class="n">value</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>We strip the braces from the params hash. As the call only has one
argument, we can provide the hash as named parameters. If params are
empty only the method name is needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">as_call</span> <span class="n">params</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">language_method_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">unless</span> <span class="n">params</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;(&quot;</span>
      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">as_named_arguments</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;)&quot;</span>
    <span class="k">end</span>
    <span class="n">result</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">as_named_arguments</span> <span class="n">params</span><span class="sr"></span>
<span class="sr">    /{(.*)}/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">inspect</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Factory method for easily generating the <em>NodeList</em> for an element.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">children_list</span> <span class="n">element</span>
  <span class="no">NodeList</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">getChildNodes</span><span class="p">)</span>
<span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p><em>NodeList</em> is a wrapper around a java NodeList that makes some
operations less verbose.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">NodeList</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>We enrich this class with a lot of useful methods by including
Enumerable.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kp">include</span> <span class="no">Enumerable</span>

  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">node_list</span>
    <span class="vi">@node_list</span> <span class="o">=</span> <span class="n">node_list</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>We expose the wrapped object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kp">attr_reader</span> <span class="ss">:node_list</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Needed method for supporting Enumerable module.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">each</span>
    <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">node_list</span><span class="o">.</span><span class="n">getLength</span><span class="p">())</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
      <span class="k">yield</span> <span class="n">node_list</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Return all children with the provided name.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">select_with_name</span> <span class="nb">name</span>
    <span class="nb">select</span><span class="p">{</span><span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span><span class="o">.</span><span class="n">java_kind_of?</span><span class="p">(</span><span class="no">XML</span><span class="o">::</span><span class="no">Element</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">name</span> <span class="o">==</span> <span class="n">n</span><span class="o">.</span><span class="n">nodeName</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 